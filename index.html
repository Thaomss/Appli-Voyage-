<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Portefeuille Voyage</title>

  <style>
    /* iPhone / Safari : Ã©viter que la page dÃ©borde */
    html, body {
      max-width: 100%;
      overflow-x: hidden;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, sans-serif;
      background:#f5f5f5;
      /* safe-area pour l'encoche + padding confortable */
      padding: calc(14px + env(safe-area-inset-top)) calc(14px + env(safe-area-inset-right)) calc(20px + env(safe-area-inset-bottom)) calc(14px + env(safe-area-inset-left));
      margin: 0 auto;
      max-width: 1040px;
      box-sizing: border-box;
    }

    h1 { text-align:center; margin: 6px 0 14px; }
    h2 { margin: 14px 0 8px; }

    label { display:block; margin-top:6px; }

    input, select, button {
      width:100%;
      padding:10px;
      margin:6px 0;
      box-sizing:border-box;
      font-size: 16px; /* Ã©vite le zoom iOS sur les inputs */
    }

    button {
      cursor:pointer;
      -webkit-appearance: none;
      appearance: none;
      border-radius: 14px;
    }

    hr { margin: 18px 0; }

    .box {
      background:#fff;
      border:1px solid #ddd;
      padding:12px;
      border-radius:14px;
    }

    .msg { margin:10px 0; padding:10px; border-radius:14px; }
    .ok { background:#eef9ee; border:1px solid #bfe6bf; }
    .warn { background:#fff7e6; border:1px solid #ffd27a; }
    .err { background:#ffecec; border:1px solid #ffb3b3; }

    .tabs { display:flex; gap:10px; margin: 10px 0 14px; }
    .tabBtn { padding:10px; border-radius:14px; border:1px solid #ddd; background:#fff; }
    .tabBtn.active { border-color:#999; font-weight:bold; }

    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .grid4 { display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px; }

    .small { font-size:12px; color:#666; }
    .neg { font-weight:800; }

    /* âœ… Le fix principal iPhone : tableaux scrollables horizontalement */
    .table-wrap {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      background:#fff;
      margin-top:10px;
      /* si trop de colonnes, on scroll dans .table-wrap au lieu de casser la page */
      min-width: 720px;
    }

    th, td {
      border:1px solid #ddd;
      padding:8px;
      text-align:center;
      vertical-align: middle;
      white-space: nowrap; /* Ã©vite que tout se casse en 2 lignes */
    }

    .noteRow td { text-align:left; background:#fafafa; white-space: normal; }
    .noteOk { color:#1b7f2a; font-weight:700; }
    .noteWarn { color:#a05a00; font-weight:700; }
    .noteInfo { color:#0b5cad; font-weight:700; }

    /* Mobile : on met tout en 1 colonne */
    @media (max-width: 980px){
      .grid2, .grid3, .grid4 { grid-template-columns:1fr; }
      body { max-width: 100%; }
      table { min-width: 760px; } /* un peu plus large pour que le scroll soit confortable */
    }
  </style>
</head>

<body>
  <h1>ğŸ§¾ Portefeuille Voyage ğŸ‡¯ğŸ‡µ</h1>

  <div class="tabs">
    <button id="tabSaisie" class="tabBtn active" type="button">ğŸ“ Saisie</button>
    <button id="tabRecap" class="tabBtn" type="button">ğŸ“Š RÃ©cap</button>
  </div>

  <div id="status" class="msg ok">âœ… OK : prÃªt</div>

  <!-- PAGE SAISIE -->
  <div id="pageSaisie">
    <div class="box">
      <h2>âš™ï¸ ParamÃ¨tres</h2>
      <div class="grid2">
        <div>
          <label>ğŸ’± Taux Â¥ â†’ â‚¬</label>
          <input id="rateInput" type="number" step="0.000001" placeholder="Ex : 0.0055" />
          <div class="small">Astuce : mets un taux moyen et ajuste si besoin, tout se recalcule</div>
        </div>
        <div>
          <label>ğŸ—’ï¸ Note</label>
          <input id="tripNote" placeholder="Ex : Japon 2025" />
          <div class="small">Juste un titre, pour toi</div>
        </div>
      </div>
      <button id="btnSaveRate" type="button">ğŸ’¾ Enregistrer paramÃ¨tres</button>
    </div>

    <hr />

    <div class="box">
      <h2>ğŸ‘¥ Participants</h2>
      <div class="grid2">
        <input id="personName" placeholder="Nom du participant (ex Thomas)" autocomplete="off" />
        <button id="btnAddPerson" type="button">â• Ajouter participant</button>
      </div>
      <div class="small">Tu peux appuyer sur EntrÃ©e</div>

      <h2>ğŸ’¶ Budget (ajouts / retraits)</h2>
      <div class="grid4">
        <select id="budgetPerson"></select>
        <input id="budgetEuro" type="number" step="0.01" placeholder="Ex : 2000" />
        <button id="btnAddBudget" type="button">â• Ajouter</button>
        <button id="btnRemoveBudget" type="button">â– Retirer</button>
      </div>
      <div class="small">Ex : Thomas +2000â‚¬ puis +1000â‚¬ plus tard, ou â– si tu tâ€™es trompÃ©</div>

      <h2>ğŸ“‹ Liste</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Participant</th>
              <th>Budget total (â‚¬)</th>
              <th>Suppr</th>
            </tr>
          </thead>
          <tbody id="peopleTable"></tbody>
        </table>
      </div>
    </div>

    <hr />

    <div class="box">
      <h2>ğŸ§¾ Ajouter une dÃ©pense</h2>

      <div class="grid3">
        <div>
          <label>ğŸ’³ PayÃ© par</label>
          <select id="payer"></select>
        </div>
        <div>
          <label>ğŸ Pour</label>
          <select id="beneficiary"></select>
          <div class="small">Par dÃ©faut : la mÃªme personne</div>
        </div>
        <div>
          <label>ğŸ·ï¸ CatÃ©gorie</label>
          <select id="category">
            <option value="ğŸš† Transport">ğŸš† Transport</option>
            <option value="ğŸœ Nourriture">ğŸœ Nourriture</option>
            <option value="ğŸ¨ HÃ´tel">ğŸ¨ HÃ´tel</option>
            <option value="ğŸ›ï¸ Shopping">ğŸ›ï¸ Shopping</option>
            <option value="ğŸŸï¸ ActivitÃ©">ğŸŸï¸ ActivitÃ©</option>
            <option value="âœ¨ Autre">âœ¨ Autre</option>
          </select>
        </div>
      </div>

      <label>ğŸ“ Description</label>
      <input id="label" placeholder="Ex : ramen, mÃ©tro, snack, shrine..." />

      <div class="grid3">
        <div>
          <label>ğŸ’´ Montant (Â¥)</label>
          <input id="yen" type="number" placeholder="Ex : 2500" />
        </div>
        <div>
          <label>ğŸ”¢ QuantitÃ©</label>
          <input id="qty" type="number" value="1" min="1" />
        </div>
        <div>
          <label>ğŸ“… Date</label>
          <input id="date" type="date" />
        </div>
      </div>

      <button id="btnAddExpense" type="button">âœ… Ajouter dÃ©pense</button>

      <h2>ğŸ§¾ DÃ©penses</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Payeur</th>
              <th>Pour</th>
              <th>CatÃ©gorie</th>
              <th>Description</th>
              <th>Â¥</th>
              <th>â‚¬</th>
              <th>Suppr</th>
            </tr>
          </thead>
          <tbody id="expenses"></tbody>
        </table>
      </div>

      <button id="btnReset" type="button">ğŸ§¨ Tout rÃ©initialiser</button>
      <div class="small">Efface participants, budgets et dÃ©penses</div>
    </div>
  </div>

  <!-- PAGE RÃ‰CAP -->
  <div id="pageRecap" style="display:none;">
    <div class="box">
      <h2>ğŸ“Š RÃ©cap</h2>

      <div class="grid2">
        <button id="btnBackup" type="button">ğŸ“¥ Sauvegarder (JSON)</button>
        <button id="btnRestore" type="button">ğŸ“¤ Restaurer (JSON)</button>
      </div>
      <input id="restoreFile" type="file" accept="application/json,.json" style="display:none;" />
      <div class="small">Conseil Safari iPhone : fais une sauvegarde 1Ã—/jour (iCloud Drive ou WhatsApp Ã  toi-mÃªme)</div>

      <div id="recapHeader" class="small" style="margin-top:8px;"></div>

      <h2>ğŸ‘¤ RÃ©sumÃ© par personne</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Personne</th>
              <th>Budget (â‚¬)</th>
              <th>PayÃ© total (â‚¬)</th>
              <th>Restant (â‚¬)</th>
              <th>Restant (Â¥)</th>
              <th>PayÃ© pour soi (â‚¬)</th>
              <th>PayÃ© pour autres (â‚¬)</th>
            </tr>
          </thead>
          <tbody id="recapPeople"></tbody>
        </table>
      </div>

      <h2>ğŸ” Qui doit quoi Ã  qui</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>DÃ©biteur</th>
              <th>CrÃ©ancier</th>
              <th>Montant (â‚¬)</th>
            </tr>
          </thead>
          <tbody id="recapDebts"></tbody>
        </table>
      </div>
      <div class="small">Seules les dÃ©penses â€œpayeur â‰  pourâ€ crÃ©ent une dette</div>

      <h2>ğŸ§¾ DÃ©tails des dÃ©penses</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Payeur</th>
              <th>Pour</th>
              <th>CatÃ©gorie</th>
              <th>Description</th>
              <th>Â¥</th>
              <th>â‚¬</th>
            </tr>
          </thead>
          <tbody id="recapDetails"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const elStatus = document.getElementById("status")
    function setStatus(type, text){
      elStatus.className = "msg " + type
      elStatus.textContent = text
    }

    function storageAvailable(){
      try {
        const k="__t__"
        localStorage.setItem(k,"1")
        localStorage.removeItem(k)
        return true
      } catch (e){
        return false
      }
    }
    const canStore = storageAvailable()

    let rate = 0.0055
    let tripNote = ""
    let people = []
    let budgets = {}
    let expenses = []

    const pageSaisie = document.getElementById("pageSaisie")
    const pageRecap = document.getElementById("pageRecap")
    const tabSaisie = document.getElementById("tabSaisie")
    const tabRecap = document.getElementById("tabRecap")

    const elRateInput = document.getElementById("rateInput")
    const elTripNote = document.getElementById("tripNote")
    const elBtnSaveRate = document.getElementById("btnSaveRate")

    const elPersonName = document.getElementById("personName")
    const elPeopleTable = document.getElementById("peopleTable")
    const elBudgetPerson = document.getElementById("budgetPerson")
    const elBudgetEuro = document.getElementById("budgetEuro")
    const elBtnAddBudget = document.getElementById("btnAddBudget")
    const elBtnRemoveBudget = document.getElementById("btnRemoveBudget")
    const elBtnAddPerson = document.getElementById("btnAddPerson")

    const elPayer = document.getElementById("payer")
    const elBeneficiary = document.getElementById("beneficiary")
    const elCategory = document.getElementById("category")
    const elLabel = document.getElementById("label")
    const elYen = document.getElementById("yen")
    const elQty = document.getElementById("qty")
    const elDate = document.getElementById("date")
    const elBtnAddExpense = document.getElementById("btnAddExpense")
    const elExpenses = document.getElementById("expenses")
    const elBtnReset = document.getElementById("btnReset")

    const elRecapHeader = document.getElementById("recapHeader")
    const elRecapPeople = document.getElementById("recapPeople")
    const elRecapDebts = document.getElementById("recapDebts")
    const elRecapDetails = document.getElementById("recapDetails")

    const elBtnBackup = document.getElementById("btnBackup")
    const elBtnRestore = document.getElementById("btnRestore")
    const elRestoreFile = document.getElementById("restoreFile")

    function loadData(){
      if (!canStore){
        setStatus("warn","âš ï¸ OK : prÃªt â€” sauvegarde navigateur bloquÃ©e en mode fichier")
        return
      }
      try{
        rate = Number(localStorage.getItem("pv_rate_v7")) || 0.0055
        tripNote = localStorage.getItem("pv_note_v7") || ""
        people = JSON.parse(localStorage.getItem("pv_people_v7")) || []
        budgets = JSON.parse(localStorage.getItem("pv_budgets_v7")) || {}
        expenses = JSON.parse(localStorage.getItem("pv_expenses_v7")) || []
      } catch(e){
        rate = 0.0055
        tripNote = ""
        people = []
        budgets = {}
        expenses = []
      }
    }

    function saveData(){
      if (!canStore) return
      localStorage.setItem("pv_rate_v7", String(rate))
      localStorage.setItem("pv_note_v7", String(tripNote))
      localStorage.setItem("pv_people_v7", JSON.stringify(people))
      localStorage.setItem("pv_budgets_v7", JSON.stringify(budgets))
      localStorage.setItem("pv_expenses_v7", JSON.stringify(expenses))
    }

    function yenToEuro(y){ return y * rate }
    function euroToYen(e){ return e / rate }

    function formatEUR(n){
      const sign = n < 0 ? "-" : ""
      const abs = Math.abs(n)
      return sign + abs.toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " â‚¬"
    }

    function formatYEN(n){
      const rounded = Math.round(n)
      const sign = rounded < 0 ? "-" : ""
      const abs = Math.abs(rounded)
      return sign + abs.toLocaleString("fr-FR") + " Â¥"
    }

    function todayISO(){
      const d = new Date()
      const y = d.getFullYear()
      const m = String(d.getMonth()+1).padStart(2,"0")
      const day = String(d.getDate()).padStart(2,"0")
      return `${y}-${m}-${day}`
    }

    function safeText(s){
      return (s ?? "").toString()
    }

    function showSaisie(){
      pageSaisie.style.display = ""
      pageRecap.style.display = "none"
      tabSaisie.classList.add("active")
      tabRecap.classList.remove("active")
      setStatus("ok","âœ… OK : prÃªt â€” saisie")
    }

    function showRecap(){
      pageSaisie.style.display = "none"
      pageRecap.style.display = ""
      tabSaisie.classList.remove("active")
      tabRecap.classList.add("active")
      renderRecap()
      setStatus("ok","âœ… OK : prÃªt â€” rÃ©cap")
    }

    function addPerson(){
      const name = (elPersonName.value || "").trim()
      if (!name) return setStatus("warn","âš ï¸ Entre un nom de participant")
      if (people.includes(name)) return setStatus("warn","âš ï¸ Ce participant existe dÃ©jÃ ")
      people.push(name)
      if (budgets[name] === undefined) budgets[name] = 0
      elPersonName.value = ""
      saveData()
      renderAll()
      setStatus("ok","âœ… Participant ajoutÃ© : " + name)
    }

    function deletePerson(name){
      people = people.filter(p => p !== name)
      delete budgets[name]
      saveData()
      renderAll()
      setStatus("ok","âœ… Participant supprimÃ© : " + name)
    }

    function addBudget(deltaSign){
      const who = elBudgetPerson.value
      const euroVal = Number(elBudgetEuro.value)
      if (!who) return setStatus("warn","âš ï¸ Ajoute dâ€™abord un participant")
      if (!isFinite(euroVal)) return setStatus("warn","âš ï¸ Entre un montant valide (ex 1000)")
      const delta = euroVal * deltaSign
      budgets[who] = Number(budgets[who] || 0) + delta
      elBudgetEuro.value = ""
      saveData()
      renderAll()
      const signEmoji = deltaSign > 0 ? "â•" : "â–"
      setStatus("ok", `âœ… ${who} ${signEmoji} ${formatEUR(Math.abs(delta))} (budget total = ${formatEUR(budgets[who])})`)
    }

    function saveParams(){
      const r = Number(elRateInput.value)
      const note = (elTripNote.value || "").trim()
      if (!r || r <= 0) return setStatus("warn","âš ï¸ Entre un taux valide (ex 0.0055)")
      rate = r
      tripNote = note
      saveData()
      renderAll()
      setStatus("ok","âœ… ParamÃ¨tres enregistrÃ©s (tout recalculÃ©)")
    }

    function addExpense(){
      const payer = elPayer.value
      const beneficiary = elBeneficiary.value
      const category = elCategory.value
      const label = (elLabel.value || "").trim()
      const yen = Number(elYen.value)
      const qty = Math.max(1, Number(elQty.value) || 1)
      const date = elDate.value || todayISO()

      if (!payer) return setStatus("warn","âš ï¸ Ajoute au moins 1 participant")
      if (!beneficiary) return setStatus("warn","âš ï¸ Choisis pour qui câ€™est payÃ©")
      if (!yen || yen <= 0) return setStatus("warn","âš ï¸ Entre un montant yen valide")

      const totalYen = Math.round(yen * qty)

      expenses.push({
        date,
        payer,
        beneficiary,
        category,
        label,
        yen: totalYen
      })

      elLabel.value = ""
      elYen.value = ""
      elQty.value = "1"
      saveData()
      renderAll()
      setStatus("ok","âœ… DÃ©pense ajoutÃ©e")
    }

    function deleteExpense(index){
      expenses.splice(index, 1)
      saveData()
      renderAll()
      setStatus("ok","âœ… DÃ©pense supprimÃ©e")
    }

    function resetAll(){
      people = []
      budgets = {}
      expenses = []
      tripNote = ""
      rate = 0.0055
      saveData()
      renderAll()
      showSaisie()
      setStatus("ok","âœ… Tout est rÃ©initialisÃ©")
    }

    function renderPeopleSelectors(){
      const options = people.map(p => `<option value="${p}">${p}</option>`).join("")
      elBudgetPerson.innerHTML = people.length ? options : `<option value="">Ajoute dâ€™abord un participant</option>`
      elPayer.innerHTML = people.length ? options : `<option value="">Ajoute dâ€™abord un participant</option>`
      elBeneficiary.innerHTML = people.length ? options : `<option value="">Ajoute dâ€™abord un participant</option>`

      if (people.length){
        if (!elPayer.value) elPayer.value = people[0]
        if (!elBeneficiary.value) elBeneficiary.value = elPayer.value
      }
    }

    function renderPeopleTable(){
      elPeopleTable.innerHTML = ""
      people.forEach(p => {
        const b = Number(budgets[p] || 0)
        const tr = document.createElement("tr")
        tr.innerHTML = `
          <td>${p}</td>
          <td>${formatEUR(b)}</td>
          <td><button type="button" data-del="${p}">ğŸ—‘ï¸</button></td>
        `
        elPeopleTable.appendChild(tr)
      })
      elPeopleTable.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", () => deletePerson(btn.dataset.del))
      })
    }

    function renderExpensesTable(){
      elExpenses.innerHTML = ""
      expenses.forEach((e, i) => {
        const euro = yenToEuro(e.yen)
        const tr = document.createElement("tr")
        tr.innerHTML = `
          <td>${e.date}</td>
          <td>${e.payer}</td>
          <td>${e.beneficiary}</td>
          <td>${e.category}</td>
          <td>${e.label || "-"}</td>
          <td>${formatYEN(e.yen)}</td>
          <td>${formatEUR(euro)}</td>
          <td><button type="button" data-i="${i}">âŒ</button></td>
        `
        elExpenses.appendChild(tr)
      })
      elExpenses.querySelectorAll("button[data-i]").forEach(btn => {
        btn.addEventListener("click", () => deleteExpense(Number(btn.dataset.i)))
      })
    }

    function renderParams(){
      elRateInput.value = String(rate)
      elTripNote.value = tripNote
      if (!elDate.value) elDate.value = todayISO()
    }

    function computeStats(){
      const stats = {}
      people.forEach(p => {
        stats[p] = {
          budget: Number(budgets[p] || 0),
          paidTotalEuro: 0,
          paidForSelfEuro: 0,
          paidForOthersEuro: 0
        }
      })

      const debts = {}

      expenses.forEach(e => {
        const euro = yenToEuro(e.yen)
        if (!stats[e.payer]) stats[e.payer] = { budget:0, paidTotalEuro:0, paidForSelfEuro:0, paidForOthersEuro:0 }
        stats[e.payer].paidTotalEuro += euro

        if (e.payer === e.beneficiary){
          stats[e.payer].paidForSelfEuro += euro
        } else {
          stats[e.payer].paidForOthersEuro += euro
          const key = `${e.beneficiary}|||${e.payer}`
          debts[key] = (debts[key] || 0) + euro
        }
      })

      Object.keys(stats).forEach(p => {
        stats[p].remainingEuro = stats[p].budget - stats[p].paidTotalEuro
        stats[p].remainingYen = euroToYen(stats[p].remainingEuro)
      })

      const debtsArr = Object.entries(debts)
        .map(([k, v]) => {
          const [debtor, creditor] = k.split("|||")
          return { debtor, creditor, euro: v }
        })
        .filter(d => d.euro > 0.0000001)
        .sort((a,b) => b.euro - a.euro)

      return { stats, debtsArr }
    }

    function buildDebtTextPerPerson(person, debtsArr){
      const owes = debtsArr.filter(d => d.debtor === person)
      const receivables = debtsArr.filter(d => d.creditor === person)

      const lines = []
      if (owes.length > 0){
        owes.forEach(d => lines.push({ kind:"owes", text:`${person} doit ${formatEUR(d.euro)} Ã  ${d.creditor}` }))
      }
      if (receivables.length > 0){
        receivables.forEach(d => lines.push({ kind:"receives", text:`${person} doit recevoir ${formatEUR(d.euro)} de ${d.debtor}` }))
      }
      if (lines.length === 0){
        lines.push({ kind:"none", text:`${person} nâ€™a aucune dette en cours` })
      }
      return lines
    }

    function renderRecap(){
      const { stats, debtsArr } = computeStats()
      elRecapHeader.textContent = `ğŸ—’ï¸ ${tripNote || "-"}  â€¢  ğŸ’± 1Â¥=${rate}â‚¬  â€¢  ğŸ§¾ ${expenses.length} dÃ©pense(s)`

      elRecapPeople.innerHTML = ""
      people.forEach(p => {
        const s = stats[p] || { budget:0, paidTotalEuro:0, remainingEuro:0, remainingYen:0, paidForSelfEuro:0, paidForOthersEuro:0 }
        const remClass = s.remainingEuro < 0 ? "neg" : ""

        const tr = document.createElement("tr")
        tr.innerHTML = `
          <td>${p}</td>
          <td>${formatEUR(s.budget)}</td>
          <td>${formatEUR(s.paidTotalEuro)}</td>
          <td class="${remClass}">${formatEUR(s.remainingEuro)}</td>
          <td class="${remClass}">${formatYEN(s.remainingYen)}</td>
          <td>${formatEUR(s.paidForSelfEuro)}</td>
          <td>${formatEUR(s.paidForOthersEuro)}</td>
        `
        elRecapPeople.appendChild(tr)

        const lines = buildDebtTextPerPerson(p, debtsArr)
        const noteTr = document.createElement("tr")
        noteTr.className = "noteRow"
        const td = document.createElement("td")
        td.colSpan = 7
        td.innerHTML = lines.map(l => {
          if (l.kind === "owes") return `<div class="noteWarn">ğŸŸ  ${l.text}</div>`
          if (l.kind === "receives") return `<div class="noteInfo">ğŸ”µ ${l.text}</div>`
          return `<div class="noteOk">âœ… ${l.text}</div>`
        }).join("")
        noteTr.appendChild(td)
        elRecapPeople.appendChild(noteTr)
      })

      elRecapDebts.innerHTML = ""
      if (debtsArr.length === 0){
        const tr = document.createElement("tr")
        tr.innerHTML = `<td colspan="3">âœ… Aucune dette</td>`
        elRecapDebts.appendChild(tr)
      } else {
        debtsArr.forEach(d => {
          const tr = document.createElement("tr")
          tr.innerHTML = `
            <td>${d.debtor}</td>
            <td>${d.creditor}</td>
            <td>${formatEUR(d.euro)}</td>
          `
          elRecapDebts.appendChild(tr)
        })
      }

      elRecapDetails.innerHTML = ""
      const ordered = [...expenses].slice().sort((a,b) => (a.date > b.date ? -1 : a.date < b.date ? 1 : 0))
      ordered.forEach(e => {
        const tr = document.createElement("tr")
        tr.innerHTML = `
          <td>${e.date}</td>
          <td>${e.payer}</td>
          <td>${e.beneficiary}</td>
          <td>${e.category}</td>
          <td>${e.label || "-"}</td>
          <td>${formatYEN(e.yen)}</td>
          <td>${formatEUR(yenToEuro(e.yen))}</td>
        `
        elRecapDetails.appendChild(tr)
      })
    }

    function renderAll(){
      renderParams()
      renderPeopleSelectors()
      renderPeopleTable()
      renderExpensesTable()
      if (pageRecap.style.display !== "none") renderRecap()
    }

    elRateInput.addEventListener("input", () => {
      const v = Number(elRateInput.value)
      if (v && v > 0) {
        rate = v
        renderAll()
      }
    })

    function buildBackupObject(){
      return {
        app: "portefeuille-voyage",
        version: 1,
        exported_at: new Date().toISOString(),
        data: { rate, tripNote, people, budgets, expenses }
      }
    }

    function safeFileName(){
      const base = (tripNote || "portefeuille").trim().toLowerCase()
        .replaceAll(" ", "-")
        .replaceAll(/[^a-z0-9\-]/g, "")
        .slice(0, 40) || "portefeuille"
      const date = todayISO()
      return `${base}-${date}.json`
    }

    async function backupNow(){
      try{
        const obj = buildBackupObject()
        const text = JSON.stringify(obj, null, 2)
        const blob = new Blob([text], { type: "application/json" })
        const fileName = safeFileName()

        try{
          const file = new File([blob], fileName, { type: "application/json" })
          if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share){
            await navigator.share({ files: [file], title: "Sauvegarde Portefeuille", text: "Sauvegarde JSON" })
            setStatus("ok", "âœ… Sauvegarde partagÃ©e (choisis iCloud/WhatsApp/Fichiers)")
            return
          }
        } catch(_){}

        const url = URL.createObjectURL(blob)
        const a = document.createElement("a")
        a.href = url
        a.download = fileName
        document.body.appendChild(a)
        a.click()
        a.remove()
        setTimeout(() => URL.revokeObjectURL(url), 2000)
        setStatus("ok", "âœ… Sauvegarde tÃ©lÃ©chargÃ©e (Fichiers / TÃ©lÃ©chargements)")
      } catch(e){
        setStatus("err", "âŒ Impossible de sauvegarder : " + (e?.message || "erreur"))
      }
    }

    function requestRestore(){
      elRestoreFile.value = ""
      elRestoreFile.click()
    }

    function validateBackup(obj){
      if (!obj || typeof obj !== "object") return false
      if (!obj.data || typeof obj.data !== "object") return false
      const d = obj.data
      if (typeof d.rate !== "number" || !(d.rate > 0)) return false
      if (!Array.isArray(d.people)) return false
      if (typeof d.budgets !== "object" || d.budgets === null) return false
      if (!Array.isArray(d.expenses)) return false
      return true
    }

    function applyBackup(obj){
      const d = obj.data
      rate = Number(d.rate)
      tripNote = safeText(d.tripNote)
      people = d.people.map(x => safeText(x)).filter(x => x.trim() !== "")
      budgets = {}
      Object.keys(d.budgets || {}).forEach(k => { budgets[safeText(k)] = Number(d.budgets[k] || 0) })
      expenses = (d.expenses || []).map(e => ({
        date: safeText(e.date) || todayISO(),
        payer: safeText(e.payer),
        beneficiary: safeText(e.beneficiary),
        category: safeText(e.category) || "âœ¨ Autre",
        label: safeText(e.label),
        yen: Math.round(Number(e.yen || 0))
      })).filter(e => e.payer && e.beneficiary && e.yen > 0)
      saveData()
      renderAll()
    }

    elRestoreFile.addEventListener("change", () => {
      const f = elRestoreFile.files && elRestoreFile.files[0]
      if (!f) return
      const reader = new FileReader()
      reader.onload = () => {
        try{
          const text = String(reader.result || "")
          const obj = JSON.parse(text)
          if (!validateBackup(obj)){
            setStatus("err", "âŒ Fichier invalide (pas une sauvegarde reconnue)")
            return
          }
          const ok = confirm("Restaurer cette sauvegarde va remplacer tes donnÃ©es actuelles. Continuer ?")
          if (!ok) return
          applyBackup(obj)
          setStatus("ok", "âœ… Sauvegarde restaurÃ©e")
          showRecap()
        } catch(e){
          setStatus("err", "âŒ Impossible de lire la sauvegarde : " + (e?.message || "erreur"))
        }
      }
      reader.onerror = () => setStatus("err", "âŒ Erreur de lecture du fichier")
      reader.readAsText(f)
    })

    tabSaisie.addEventListener("click", showSaisie)
    tabRecap.addEventListener("click", showRecap)

    elBtnSaveRate.addEventListener("click", saveParams)
    elBtnAddPerson.addEventListener("click", addPerson)

    elBtnAddBudget.addEventListener("click", () => addBudget(+1))
    elBtnRemoveBudget.addEventListener("click", () => addBudget(-1))

    elBtnAddExpense.addEventListener("click", addExpense)
    elBtnReset.addEventListener("click", resetAll)

    elBtnBackup.addEventListener("click", backupNow)
    elBtnRestore.addEventListener("click", requestRestore)

    elPersonName.addEventListener("keydown", (e) => { if (e.key === "Enter") addPerson() })
    elBudgetEuro.addEventListener("keydown", (e) => { if (e.key === "Enter") addBudget(+1) })
    elLabel.addEventListener("keydown", (e) => { if (e.key === "Enter") addExpense() })
    elYen.addEventListener("keydown", (e) => { if (e.key === "Enter") addExpense() })

    elPayer.addEventListener("change", () => {
      if (elBeneficiary.value === "" || elBeneficiary.value === elPayer.value) {
        elBeneficiary.value = elPayer.value
      }
    })

    loadData()
    renderAll()

    if (canStore){
      setStatus("ok","âœ… OK : prÃªt â€” iPhone OK (tableaux scrollables)")
    } else {
      setStatus("warn","âš ï¸ OK : prÃªt â€” mais la sauvegarde navigateur est bloquÃ©e en mode fichier")
    }
  </script>
</body>
</html>
